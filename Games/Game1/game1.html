<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Survival</title>
    <link rel="shortcut icon" type="image/PNG" href="../../favicon.PNG">
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style type="text/css">
        body,html {
            margin: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;    
            background-image: url('../../Images/background3.jpeg');
            background-size: 50vh;
            background-repeat: repeat;
        }
        canvas {
            border-color: #feb20d; /* feb20d */
            border-style: solid;
            border-width: .5vh;
            border-radius: 5vh;
        }


    </style>
</head>
<body>
<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 1280,
    height: 720,
    physics: {
        default: 'arcade',
        arcade: {
            // gravity: {y: 200},
            debug: false,
        },
    }, 
    fps: {
        target: 60,
        forceSetTimeOut: true,
    },
    pixelArt: true,
    scene: {
        preload: preload,
        create: create,
        update: update
    }

};

var game = new Phaser.Game(config);


//player
var player;
var thrust;
var playerBullets;
var fireTime = 0, MAXFIRERATE = 10;
//stars
var stars;
var starColors = ['ebc634','34d3eb','eb34d9','34eb46', 'ffffff', 'ffffff', 'ffffff']
//enemies
var enemies1;
//input keys
var keyW, keyA, keyS, keyD, keySpace;


function preload(){
    //images
    this.load.image('star','assets/star.png');
    this.load.image('pBullet','assets/pBullet.png');
    
    //spritesheets
    this.load.spritesheet('ship','assets/ship.png', {frameWidth: 16, frameHeight: 14});
    this.load.spritesheet('thrust','assets/thrust.png', {frameWidth: 10,frameHeight: 7, spacing: 1});
    this.load.spritesheet('enemies1','assets/enemy1.png', {frameWidth: 16, frameHeight: 13});
}


function create(){

    //space (aka moving stars)
    stars = this.physics.add.group({
        key: 'star',
        repeat: 30,
    });
    
    stars.children.iterate((star) => {
        let size = Phaser.Math.Between(1,3);
        star.setScale(size, size);
        star.setX(Phaser.Math.Between(0,1280));
        star.setY(Phaser.Math.Between(0,720));
        star.setTint(parseInt('0x' + starColors[Phaser.Math.Between(0,6)]));
        star.setVelocityY(Phaser.Math.Between(100,500));//also changed in the update method
    });


    //thrust  --> must be drawn before the ship (under)
    thrust = this.physics.add.sprite(640,500,'thrust').setScale(5);

    this.anims.create({
        key: 'big',
        frames: [{key: 'thrust', frame: 0}]
    });
    this.anims.create({
        key: 'small',
        frames: [{key: 'thrust', frame: 2}]
    });
    this.anims.create({
        key: 'none',
        frames: [{key: 'thrust', frame: 1}]
    });
    
    
    //player
    player = this.physics.add.sprite(640,500,'ship').setScale(5);
    
    this.anims.create({
        key: 'left',
        frames: [{key: 'ship',frame: 0}],
    });
    this.anims.create({
        key: 'center',
        frames: [{key: 'ship',frame: 1}],
    });
    this.anims.create({
        key: 'right',
        frames: [{key: 'ship',frame: 2}],
    });
    


    //player bullets
    playerBullets = this.physics.add.group();

    //enemies1 
    //creating 3 enemies as a test, hence this will change
    enemies1 = this.physics.add.group({
        key: 'enemies1',
        repeat: 2,
        setXY: {x: 320,y: 0, stepX: 320},
        setScale: {x: 3,y: 3}
    });
    
    enemies1.children.iterate((e1) => {
        e1.setVelocityY(Phaser.Math.Between(300,600));
    });

    this.anims.create({
        key: 'move',
        frames: this.anims.generateFrameNumbers('enemies1',{start: 0, end: 4}),
        frameRate: 15,
        repeat: -1
    });


    //colliders
    player.setCollideWorldBounds(true);
    this.physics.add.collider(playerBullets, enemies1, enemyHit, null, this);

    //inputs 
    keyW = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
    keyA = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
    keyS = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
    keyD = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);
    keySpace = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
}


function update(){
    //input handling
    //movement vertical
    if(keyW.isDown){
        thrust.anims.play('small');
        player.setVelocityY(player.body.velocity.y - 20);
        thrust.y = player.y + (player.height - thrust.height/2-4)*5;
    }
    else if(keyS.isDown){
        thrust.anims.play('none');
        player.setVelocityY(player.body.velocity.y + 20);
        thrust.y = player.y + (player.height - thrust.height/2-4)*5;
    }
    else{
        thrust.anims.play('small');
        //get to 0 in a smooth way from either direction (up or down)
        if(player.body.velocity.y < 0){
            player.setVelocityY(player.body.velocity.y + 20);
        }
        else if(player.body.velocity.y > 0){
            player.setVelocityY(player.body.velocity.y - 20);
        }
        thrust.y = player.y + (player.height - thrust.height/2-4)*5;
    }

    //movement horizontal
    if(keyA.isDown){
        player.anims.play('left');
        player.setVelocityX(-500);
        thrust.x = player.x-10;
    }
    else if(keyD.isDown){
        player.anims.play('right');
        player.setVelocityX(500);
        thrust.x = player.x+10;
    }
    else{
        thrust.x = player.x;
        player.anims.play('center');
        player.setVelocityX(0);
    }

    //shooting
    if(fireTime > 0){
        fireTime--;
    }
    else if(keySpace.isDown){
        fireTime = MAXFIRERATE;
        playerBullets.create(player.x, player.y, 'pBullet').setVelocityY(-2000).setScale(3);
    }

    playerBullets.children.each((pB) => {
        //out of screeen
        if(pB.y < 0){
            pB.destroy();
        }
    });

    //change star X and reset Y to make a moving space
    stars.children.iterate((star) => {
        if(star.y > 720 ){
            star.y = -1;
            star.x = Phaser.Math.Between(0,1280);
            star.setVelocityY(Phaser.Math.Between(100,500));
        }
    });

    //enemy movement -->mostly temp
    enemies1.children.iterate((e1) =>{
        e1.anims.play('move', true);
        if(e1.y >= 720){
            e1.y = 0;
            e1.x = (Phaser.Math.Between(0,1280));
            e1.setVelocityY(Phaser.Math.Between(300,600));
            e1.setVelocityX(Phaser.Math.Between(-400,400));
        }
    });


    //end game 

}

//other functions
function enemyHit(pB, e1){
    pB.destroy();
    e1.destroy();
    //score goes up, spawn other enemies, this will change
}

</script>
</body>
</html>