<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Survival</title>
    <link rel="shortcut icon" type="image/PNG" href="../../favicon.PNG">
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style type="text/css">
        body,html {
            margin: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;    
            background-color: black;
            background-image: url('../../Images/background3.jpeg');
            background-size: 50vh;
            background-repeat: repeat;
        }

    </style>
</head>
<body>
<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 1280,
    height: 720,
    scale : {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH,//for when i implement fs
    },
    physics: {
        default: 'arcade',
        arcade: {
            // gravity: {y: 200},
            debug: false,
        },
    }, 
    fps: {
        target: 60,
        forceSetTimeOut: true,
    },
    pixelArt: true,
    scene: {
        preload: preload,
        create: create,
        update: update
    }

};

var game = new Phaser.Game(config);


//player
var player;
var thrust;
var playerBullets;
var fireTime = MAXFIRERATE = 8;
//stars
var stars;
var starColors = ['ebc634','34d3eb','eb34d9','34eb46', 'ffffff', 'ffffff', 'ffffff']
//side rocks
var sideRocks;
//enemies
var enemies1;
//input keys
var keyW, keyA, keyS, keyD, keySpace;

//text
var FPS = 0;


function preload(){
    //images
    this.load.image('star','assets/star.png');
    this.load.image('sideRock','assets/clouds.png');
    this.load.image('pBullet','assets/pBullet.png');
    
    //spritesheets
    this.load.spritesheet('shipNT','assets/shipST.png', {frameWidth: 16, frameHeight: 14});
    this.load.spritesheet('shipST','assets/shipST.png', {frameWidth: 16, frameHeight: 21});
    this.load.spritesheet('shipBT','assets/shipBT.png', {frameWidth: 16, frameHeight: 22});
    this.load.spritesheet('enemies1','assets/enemy1.png', {frameWidth: 16, frameHeight: 13});
}


function create(){
    this.physics.world.setBounds(140,0,1000,720);

    //space (aka moving stars)
    stars = this.physics.add.group({
        key: 'star',
        repeat: 30,
    });
    
    stars.children.iterate((star) => {
        let size = Phaser.Math.Between(1,2);
        star.setScale(size, size);
        star.setX(Phaser.Math.Between(140,1000));//aslso changed in the update method
        star.setY(Phaser.Math.Between(0,720));
        star.setTint(parseInt('0x' + starColors[Phaser.Math.Between(0,6)]));
        star.setVelocityY(Phaser.Math.Between(100,500));//also changed in the update method
    });

    //side rocks
    sideRocks = this.physics.add.group();
    
    sideRocks.create(0,512,'sideRock').setScale(4).setAngle(180);
    sideRocks.create(0,-512,'sideRock').setScale(4).setAngle(180);
    sideRocks.create(1280,512,'sideRock').setScale(4);
    sideRocks.create(1280,-512,'sideRock').setScale(4);
    
    sideRocks.setTint('0x6d6145');
    
    
    //player
    player = this.physics.add.sprite(640,500,'shipST').setScale(5).setOrigin(0,0);
    
    //small thrust
    this.anims.create({
        key: 'leftST',
        frames: [{key: 'shipST',frame: 0}],
    });
    this.anims.create({
        key: 'centerST',
        frames: [{key: 'shipST',frame: 1}],
    });
    this.anims.create({
        key: 'rightST',
        frames: [{key: 'shipST',frame: 2}],
    });

    //big thrust
    this.anims.create({
        key: 'leftBT',
        frames: [{key: 'shipBT',frame: 0}],
    });
    this.anims.create({
        key: 'centerBT',
        frames: [{key: 'shipBT',frame: 1}],
    });
    this.anims.create({
        key: 'rightBT',
        frames: [{key: 'shipBT',frame: 2}],
    });

    //no thrust
    this.anims.create({
        key: 'leftNT',
        frames: [{key: 'shipNT',frame: 0}],
    });
    this.anims.create({
        key: 'centerNT',
        frames: [{key: 'shipNT',frame: 1}],
    });
    this.anims.create({
        key: 'rightNT',
        frames: [{key: 'shipNT',frame: 2}],
    });
    

    //player bullets
    playerBullets = this.physics.add.group();//created in runtime

    //enemies1 
    //creating 3 enemies as a test, hence this will change
    enemies1 = this.physics.add.group({
        key: 'enemies1',
        repeat: 2,
        setXY: {x: 320,y: 0, stepX: 320},
        setScale: {x: 3,y: 3}
    });
    
    enemies1.children.iterate((e1) => {
        e1.setVelocityY(Phaser.Math.Between(300,600));
    });

    this.anims.create({
        key: 'move',
        frames: this.anims.generateFrameNumbers('enemies1',{start: 0, end: 4}),
        frameRate: 15,
        repeat: -1
    });


    //colliders
    player.setCollideWorldBounds(true);
    this.physics.add.collider(playerBullets, enemies1, enemyHit, null, this);

    //inputs 
    keyW = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
    keyA = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
    keyS = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
    keyD = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);
    keySpace = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

    //text
    FPS = this.add.text(1220, 16, '0', { fontSize: '32px', fill: '#ffffff' });
}


function update(){
    //movement vertical
    if(keyW.isDown){
        player.anims.play('centerBT');
        player.setVelocityY(player.body.velocity.y - 20);
    }
    else if(keyS.isDown){
        player.anims.play('centerNT');
        player.setVelocityY(player.body.velocity.y + 20);
    }
    else{
        //get to 0 in a smooth way from either direction (up or down)
        player.anims.play('centerST');
        if(player.body.velocity.y < 0){
            player.setVelocityY(player.body.velocity.y + 20);
        }
        else if(player.body.velocity.y > 0){
            player.setVelocityY(player.body.velocity.y - 20);
        }
    }

    //movement horizontal
    if(keyA.isDown){
        if(keyW.isDown){
            player.anims.play('leftBT');
        }
        else if(keyS.isDown){
            player.anims.play('leftNT');
        }else{
            player.anims.play('leftST');
        }
        player.setVelocityX(-500);
    }
    else if(keyD.isDown){
        if(keyW.isDown){
            player.anims.play('rightBT');
        }
        else if(keyS.isDown){
            player.anims.play('rightNT');
        }else{
            player.anims.play('rightST');
        }
        player.setVelocityX(500);
    }
    else{
        player.setVelocityX(0);
    }

    //shooting
    if(fireTime > 0){
        fireTime--;
    }
    else if(keySpace.isDown){
        fireTime = MAXFIRERATE;
        playerBullets.create(player.x + 18, player.y, 'pBullet').setVelocityY(-1500).setScale(3);
        playerBullets.create(player.x + 61, player.y, 'pBullet').setVelocityY(-1500).setScale(3);
    } 

    playerBullets.children.each((pB) => {
        //out of screeen
        if(pB.y < 0){
            pB.destroy();
        }
    });


    //enemy movement -->mostly temp
    enemies1.children.iterate((e1) =>{
        e1.anims.play('move', true);
        if(e1.y >= 720){
            e1.y = 0;
            e1.x = (Phaser.Math.Between(0,1280));
            e1.setVelocityY(Phaser.Math.Between(300,600));
            e1.setVelocityX(Phaser.Math.Between(-400,400));
        }
    });

    //moving sensation
    //change star X and reset Y to make a moving space
    stars.children.iterate((star) => {
        if(star.y > 720 ){
            star.y = -1;
            star.x = Phaser.Math.Between(140,1000);
            star.setVelocityY(Phaser.Math.Between(100,500));
        }
    });

    //moving sides --> resets their y pos back to -512 to maintain a flawless loop 
    sideRocks.children.iterate((sideRock) => {
        sideRock.y += 16;
        if(sideRock.y >= 1232){
            sideRock.y = -512;//should be -816, though i am allowing some overlap just in case
        }
    });

    //update current fps 
    FPS.setText(Phaser.Math.RoundTo(this.game.loop.actualFps,0));
    //end game 

}

//other functions
function enemyHit(pB, e1){
    pB.destroy();
    e1.destroy();
    //score goes up, spawn other enemies, this will change
}

</script>
</body>
</html>